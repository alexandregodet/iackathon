name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  FLUTTER_VERSION: '3.38.3'
  JAVA_VERSION: '17'

jobs:
  # ============================================
  # Create Release with APK and AAB
  # ============================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      - name: Build Release APK
        run: |
          flutter build apk --release \
            --build-name=${{ steps.version.outputs.VERSION }} \
            --build-number=${{ github.run_number }}

      - name: Build Release App Bundle
        run: |
          flutter build appbundle --release \
            --build-name=${{ steps.version.outputs.VERSION }} \
            --build-number=${{ github.run_number }}

      - name: Rename artifacts
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk \
             build/app/outputs/flutter-apk/iackathon-${{ steps.version.outputs.VERSION }}.apk
          mv build/app/outputs/bundle/release/app-release.aab \
             build/app/outputs/bundle/release/iackathon-${{ steps.version.outputs.VERSION }}.aab

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" -20)
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.version.outputs.VERSION }}
          body: |
            ## What's Changed
            ${{ steps.changelog.outputs.CHANGELOG }}

            ## Downloads
            - **APK**: Direct install on Android devices
            - **AAB**: For Google Play Store upload

            ## Installation
            1. Download the APK file
            2. Enable "Install from unknown sources" on your Android device
            3. Install the APK
          files: |
            build/app/outputs/flutter-apk/iackathon-${{ steps.version.outputs.VERSION }}.apk
            build/app/outputs/bundle/release/iackathon-${{ steps.version.outputs.VERSION }}.aab
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Build iOS for Release
  # ============================================
  release-ios:
    name: Build iOS Release
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build iOS (no codesign)
        run: |
          flutter build ios --release --no-codesign \
            --build-name=${{ steps.version.outputs.VERSION }} \
            --build-number=${{ github.run_number }}

      - name: Create iOS artifact
        run: |
          cd build/ios/iphoneos
          zip -r ../../../ios-release-${{ steps.version.outputs.VERSION }}.zip Runner.app

      - name: Upload iOS to Release
        uses: softprops/action-gh-release@v2
        with:
          files: ios-release-${{ steps.version.outputs.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
